<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Drunk Frog</title>
  <link href="style.css" rel="stylesheet" type="text/css" media="all">
  <link rel="apple-touch-icon" sizes="180x180" href="favicon/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon/favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
  <style>
    .window {
      padding: 10px;
    }
  </style>
</head>
<body onload="showExternalContent('page/progress.html'); showDailyPopup()">
  <div class="logo" onclick="window.location.href='index.html'"></div>
  <div class="window-body">
    <menu role="tablist">
      <li data-url="page/progress.html" role="tab" aria-selected="true"><a href="#tabs">Progress</a></li>
      <li data-url="page/article.html" role="tab" aria-selected="False"><a href="#tabs">Article</a></li>
      <li data-url="page/game_design.html" role="tab" aria-selected="false"><a href="#tabs">Game Design</a></li>
      <li data-url="page/about.html" role="tab" aria-selected="false"><a href="#tabs">About Me</a></li>
    </menu>
    <div class="window" role="tabpanel"></div>
    <div class="window-body">
  </div>
</div>
</div>


<button class="back-to-top" onclick="scrollToTop()">
  <img src="\icon\go-top.png" alt="Back to Top" style="vertical-align: middle;">
</button>
  <div class="crt monitor"></div>

  <script>
document.addEventListener('DOMContentLoaded', function() {
  const tabList = document.querySelector('[role="tablist"]');
  const tabs = document.querySelectorAll('[role="tab"]');
  let currentUrl = null; // 用于存储当前显示的内容的 URL

  tabList.addEventListener('click', function(event) {
    const clickedTab = event.target.closest('[role="tab"]');
    if (!clickedTab) return;

    const url = clickedTab.getAttribute('data-url');
    if (url === currentUrl) return; // 如果点击的标签与当前显示的内容相同，则不进行重新加载

    const content = document.querySelector('.window');
    content.innerHTML = ''; // 清空之前的内容

    showExternalContent(url).then(() => {
      tabs.forEach(tab => tab.setAttribute('aria-selected', 'false'));
      clickedTab.setAttribute('aria-selected', 'true');
      currentUrl = url; // 更新当前显示的内容的 URL
    });
  });

  window.addEventListener('scroll', handleScroll);
  handleScroll();

  fetchAndProcess('/ui/footer.html', displayFooterContent, error => {
    console.error('Error loading footer:', error);
  });
});

// 配置项：弹窗展示时间间隔，单位为秒
const popupInterval = 86400; // 默认值为 24 小时（86400 秒）

async function showExternalContent(url) {
  console.log('showExternalContent called with url:', url);
  await fetchAndProcess(url, (data) => displayContent(data, url), displayError);
}

async function fetchAndProcess(url, successCallback, errorCallback) {
  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error('Network response was not ok ' + response.statusText);
    const data = await response.text();
    successCallback(data);
  } catch (error) {
    console.error('Error loading content:', error);
    if (errorCallback) errorCallback(error); // 确保 errorCallback 存在时才调用
  }
}

function displayContent(html, url) {
  const content = document.querySelector('.window');
  content.classList.remove('active');
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, "text/html");

  const externalTitle = doc.querySelector('title')?.innerText || "Default Title";
  document.title = `${document.title.split(' - ')[0]} - ${externalTitle}`;

  content.innerHTML = doc.querySelector('body').innerHTML;
  setTimeout(() => content.classList.add('active'), 10); // 确保内容完全加载后再显示

  // 确保 CSS 和 JS 代码生效
  doc.querySelectorAll('style').forEach(style => {
    if (!document.head.querySelector(`style[data-id="${style.getAttribute('data-id')}"]`)) {
      document.head.appendChild(style);
    }
  });

  doc.querySelectorAll('script').forEach(script => {
    if (!document.body.querySelector(`script[data-id="${script.getAttribute('data-id')}"]`)) {
      const newScript = document.createElement('script');
      newScript.textContent = script.textContent;
      document.body.appendChild(newScript);
    }
  });

  if (url === 'page/progress.html') updateProgressBar();
}

function displayError(error) {
  const content = document.querySelector('.window');
  content.innerHTML = `<p>Error loading content: ${error.message}</p>`;
  content.classList.add('active');
}

function scrollToTop() {
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

function handleScroll() {
  const button = document.querySelector('.back-to-top');
  button.style.display = window.scrollY > 300 ? 'block' : 'none';
}

async function showDailyPopup() {
  const now = new Date();
  const lastShown = localStorage.getItem('dailyPopupLastShown');
  const lastShownDate = lastShown ? new Date(lastShown) : null;

  if (!lastShownDate || (now - lastShownDate) / 1000 >= popupInterval) {
    await fetchAndProcess('ui/dailyPopup.html', displayPopupContent, error => {
      console.error('Error loading daily popup:', error);
    });
  }
}

function displayPopupContent(html) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, "text/html");

  const popupContainer = document.createElement('div');
  popupContainer.innerHTML = doc.querySelector('body').innerHTML;
  document.body.appendChild(popupContainer);

  doc.querySelectorAll('style').forEach(style => {
    if (!document.head.querySelector(`style[data-id="${style.getAttribute('data-id')}"]`)) {
      document.head.appendChild(style);
    }
  });

  doc.querySelectorAll('script').forEach(script => {
    if (!document.body.querySelector(`script[data-id="${script.getAttribute('data-id')}"]`)) {
      const newScript = document.createElement('script');
      newScript.textContent = script.textContent;
      document.body.appendChild(newScript);
    }
  });

  localStorage.setItem('dailyPopupLastShown', new Date().toISOString());
}

function displayFooterContent(html) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, "text/html");

  const footerContainer = document.querySelector('.dynamic-footer');
  footerContainer.innerHTML = doc.querySelector('body').innerHTML;

  doc.querySelectorAll('style').forEach(style => {
    if (!document.head.querySelector(`style[data-id="${style.getAttribute('data-id')}"]`)) {
      document.head.appendChild(style);
    }
  });

  doc.querySelectorAll('script').forEach(script => {
    if (!document.body.querySelector(`script[data-id="${script.getAttribute('data-id')}"]`)) {
      const newScript = document.createElement('script');
      newScript.textContent = script.textContent;
      document.body.appendChild(newScript);
    }
  });
}
  </script>
</body>
<div class="dynamic-footer"></div>
</html>
